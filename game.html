<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯ - ã‚«ã‚¸ãƒãƒ¢ãƒ¼ãƒ‰</title>
    <style>
        /* ======================== */
        /* ã‚²ãƒ¼ãƒ ç”»é¢ã®CSS - ã‚«ã‚¸ãƒé¢¨èƒŒæ™¯ (ã‚­ãƒ©ã‚­ãƒ©å¼·åŒ– + è¦ç´ è¿½åŠ ) */
        /* ======================== */
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background-color: #0d230d; /* ã•ã‚‰ã«æ·±ã„ãƒ€ãƒ¼ã‚¯ã‚°ãƒªãƒ¼ãƒ³ */
            /* ã‚­ãƒ©ã‚­ãƒ©ã—ãŸã‚«ã‚¸ãƒã®ç…§æ˜ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ãŸè±ªè¯ãªèƒŒæ™¯ */
            background-image: 
                /* ã‚·ãƒ£ãƒ³ãƒ‡ãƒªã‚¢ (ä¸Šéƒ¨) */
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20" width="100%" height="20%"><defs><filter id="f1" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur in="SourceGraphic" stdDeviation="2" /></filter></defs><rect x="0" y="0" width="100" height="20" fill="transparent"/><path d="M50 0 L45 20 L55 20 Z" fill="#FFD700" filter="url(%23f1)"/><circle cx="50" cy="5" r="3" fill="#FFFACD" filter="url(%23f1)"/><path d="M40 10 C45 0, 55 0, 60 10 Q50 15, 40 10 Z" fill="#FFD700" filter="url(%23f1)"/></svg>') top center no-repeat,
                /* èµ¤ã„æ¤…å­ (ä¸‹éƒ¨) */
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20" width="100%" height="20%"><rect x="0" y="0" width="100" height="20" fill="transparent"/><path d="M10 20 H90 V10 Q50 0, 10 10 Z" fill="#8B0000"/><path d="M15 15 H85 V10 C80 5, 20 5, 15 10 Z" fill="#B22222"/></svg>') bottom center no-repeat,
                radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, rgba(0, 0, 0, 0) 60%),
                radial-gradient(ellipse at bottom left, #ccac00 0%, transparent 40%),
                radial-gradient(ellipse at top right, #ff9800 0%, transparent 40%),
                repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.05) 0px, rgba(255, 255, 255, 0.05) 1px, transparent 1px, transparent 5px);
            background-size: 
                auto 150px, /* ã‚·ãƒ£ãƒ³ãƒ‡ãƒªã‚¢ã®é«˜ã• */
                auto 100px, /* æ¤…å­ã®é«˜ã• */
                cover, /* ãã®ä»–ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
                cover,
                cover,
                cover;
            background-attachment: fixed; /* èƒŒæ™¯ã‚’å›ºå®šã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚å‹•ã‹ãªã„ã‚ˆã†ã« */
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: rgba(0, 0, 0, 0.75);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.3);
            border: 5px solid #ccac00;
        }
        
        /* ã‚¤ãƒ³ãƒ•ã‚©ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ (ãƒãƒƒãƒ—ã€é€£å‹æ•°) */
        #infoBar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; background-color: #0b4920; border-radius: 8px;
            margin-bottom: 20px; font-size: 1.1em; font-weight: bold;
        }
        .info-item { display: flex; align-items: center; }
        .chip-icon { color: gold; margin-right: 5px; font-size: 1.2em; }
        .win-streak-icon { color: #ff4500; margin-right: 5px; font-size: 1.2em; }

        /* ãƒ™ãƒƒãƒˆ/é›£æ˜“åº¦é¸æŠã‚¨ãƒªã‚¢ */
        #preGameControls {
            margin-bottom: 20px; padding: 15px; background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px; display: flex; justify-content: center; align-items: center; gap: 25px;
        }
        select, input[type="number"] {
            padding: 8px; border-radius: 5px; font-size: 1em;
            background-color: #fff; color: #333; border: 1px solid #ccc;
        }
        
        /* ã‚²ãƒ¼ãƒ è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå‰å›åŒæ§˜ï¼‰ */
        .hand { margin-bottom: 20px; border: 2px dashed #66bb6a; padding: 15px; border-radius: 8px; }
        .cards { display: flex; justify-content: center; margin: 10px 0; min-height: 100px; flex-wrap: wrap; }
        .card { 
            background-color: #fff; color: #000; border: 1px solid #000; border-radius: 5px;
            width: 70px; height: 90px; display: flex; flex-direction: column; justify-content: space-between;
            align-items: center; margin: 0 5px; padding: 5px; font-size: 1.2em;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3); font-weight: bold;
        }
        .card.hidden { background-color: #8b0000; color: #fff; font-size: 1em; display: flex; justify-content: center; align-items: center; font-style: italic; }
        
        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        button { padding: 10px 20px; font-size: 1em; margin: 5px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-weight: bold; }
        #dealButton { background-color: #2196f3; color: #fff; }
        #dealButton:hover { background-color: #1e88e5; }
        #hitButton { background-color: #ff9800; color: #fff; }
        #hitButton:hover { background-color: #e68900; }
        #standButton { background-color: #4caf50; color: #fff; }
        #standButton:hover { background-color: #43a047; }
        
        /* çµ‚äº†å¾Œãƒœã‚¿ãƒ³ */
        #postGameButtons { margin-top: 20px; }
        #nextGameButton { background-color: #ccac00; color: #333; }
        #endGameButton { background-color: #8b0000; color: #fff; }
        #nextGameButton:hover { background-color: #b29300; }
        #endGameButton:hover { background-color: #6a0000; }

        #message { font-size: 1.5em; margin-top: 20px; font-weight: bold; }
        
        /* ======================== */
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒ«ãƒ¼ãƒ«)CSS - é«˜ç´šæ„Ÿå¾©æ´» */
        /* ======================== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; justify-content: center; align-items: center; z-index: 100;
        }

        .modal-content {
            background-color: #f5f5dc; /* ã‚«ã‚¸ãƒé¢¨ã®ã‚¢ã‚¤ãƒœãƒªãƒ¼/ãƒ™ãƒ¼ã‚¸ãƒ¥ã®ç´™è‰² */
            color: #333;
            width: 90%; max-width: 500px;
            padding: 40px 30px 20px 30px;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.9);
            border: 8px solid #ccac00; /* ã‚´ãƒ¼ãƒ«ãƒ‰ã®æ  */
            /* ç´™ã®è³ªæ„Ÿã‚’è¿½åŠ  */
            background-image: 
                linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 20px 20px; /* ç›®ç«‹ãŸãªã„æ ¼å­æ¨¡æ§˜ */
            text-shadow: 1px 1px 0 rgba(255,255,255,0.3); /* æ–‡å­—ã«å°‘ã—æ·±ã¿ */
        }

        .close-button {
            position: absolute; top: 5px; right: 15px;
            background: none; border: none; color: #333;
            font-size: 2em; cursor: pointer; z-index: 101;
        }
        
        .rule-title {
            color: #8b0000; border-bottom: 2px solid #ccac00;
            padding-bottom: 5px; margin-bottom: 15px;
        }
        
        .rule-list { text-align: left; margin-bottom: 20px; }
        .rule-list li { margin-bottom: 10px; line-height: 1.5; }

    </style>
</head>
<body>

<div id="ruleModal" class="modal-overlay">
    <div class="modal-content">
        <button id="closeModal" class="close-button">&times;</button>
        <h2 class="rule-title">â™¦ ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯ã®ãƒ«ãƒ¼ãƒ« â™¦</h2>
        
        <ul class="rule-list">
            <li>ç›®æ¨™ã¯ã€æ‰‹æœ­ã®åˆè¨ˆã‚’ **21ã«è¿‘ã¥ã‘ã‚‹**ã“ã¨ã§ã™ã€‚21ã‚’è¶…ãˆã‚‹ã¨**ãƒã‚¹ãƒˆï¼ˆè² ã‘ï¼‰**ã¨ãªã‚Šã¾ã™ã€‚</li>
            <li>**ã‚«ãƒ¼ãƒ‰ã®æ•°ãˆæ–¹:** A=1ç‚¹ã¾ãŸã¯11ç‚¹, J/Q/K=10ç‚¹, 2ã€œ10=ãã®ã¾ã¾ã®æ•°å­—ã€‚</li>
            <li>**ã€ãƒãƒƒãƒ—ã¨ãƒ™ãƒƒãƒˆã€‘** ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«**è³­ã‘é‡‘ (ãƒ™ãƒƒãƒˆ)** ã‚’æ±ºã‚ã¾ã™ã€‚
                <ul>
                    <li>**å‹åˆ©**: è³­ã‘é‡‘ã®**2å€**ãŒæˆ»ã‚Šã¾ã™ã€‚</li>
                    <li>**ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯ (21ç‚¹)**: è³­ã‘é‡‘ã®**2.5å€**ãŒæˆ»ã‚Šã¾ã™ã€‚</li>
                    <li>**ãƒ—ãƒƒã‚·ãƒ¥ (å¼•ãåˆ†ã‘)**: è³­ã‘é‡‘ãŒãã®ã¾ã¾æˆ»ã‚Šã¾ã™ã€‚</li>
                </ul>
            </li>
            <li>**HIT (ãƒ’ãƒƒãƒˆ)**: ã‚«ãƒ¼ãƒ‰ã‚’ã‚‚ã†1æšå¼•ãã¾ã™ã€‚</li>
            <li>**STAND (ã‚¹ã‚¿ãƒ³ãƒ‰)**: ç¾åœ¨ã®æ‰‹æœ­ã§å‹è² ã—ã€ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã«ç§»ã‚Šã¾ã™ã€‚</li>
            <li>**ã€é€£ç¶šå‹åˆ©ãƒœãƒ¼ãƒŠã‚¹ã€‘** é€£ç¶šã§å‹åˆ©ã™ã‚‹ã¨ã€ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒã‚ˆã‚Šæ‰‹å¼·ããªã‚Šã¾ã™ã€‚</li>
        </ul>
        
        <p>â€» ã“ã®ã‚²ãƒ¼ãƒ ã¯ç´”ç²‹ãªç·´ç¿’ç”¨ã§ã‚ã‚Šã€é‡‘éŠ­ã¯ä¸€åˆ‡é–¢ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        <div class="modal-actions">
             <p style="color:#8b0000; font-weight: bold;">æº–å‚™ãŒã§ããŸã‚‰ã€å³ä¸Šã® [âœ•] ãƒœã‚¿ãƒ³ã§é–‰ã˜ã¾ã—ã‚‡ã†ã€‚</p>
        </div>
    </div>
</div>

<div class="container">
    <h1>BLACKJACK</h1>
    
    <div id="infoBar">
        <div class="info-item">
            <span class="chip-icon">ğŸ’°</span> ãƒãƒƒãƒ—: <span id="chipsAmount">1000</span>
        </div>
        <div class="info-item">
            <span class="win-streak-icon">ğŸ”¥</span> é€£ç¶šå‹åˆ©: <span id="winStreak">0</span>
        </div>
    </div>

    <div id="preGameControls">
        <div>
            <label for="difficulty">é›£æ˜“åº¦:</label>
            <select id="difficulty">
                <option value="14">ã‚¤ãƒ¼ã‚¸ãƒ¼</option>
                <option value="17" selected>ãƒãƒ¼ãƒãƒ«</option>
                <option value="18">ãƒãƒ¼ãƒ‰</option>
            </select>
        </div>
        <div>
            <label for="betAmount">ãƒ™ãƒƒãƒˆé¡:</label>
            <input type="number" id="betAmount" value="50" min="10" step="10">
        </div>
    </div>
    
    <div id="dealerHand" class="hand">
        <h2>ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®æ‰‹æœ­: <span id="dealerScore">0</span></h2>
        <div id="dealerCards" class="cards"></div>
    </div>

    <div id="playerHand" class="hand">
        <h2>ã‚ãªãŸã®æ‰‹æœ­: <span id="playerScore">0</span></h2>
        <div id="playerCards" class="cards"></div>
    </div>

    <div id="buttons">
        <button id="dealButton">å‹è² é–‹å§‹</button>
        <button id="hitButton" disabled>ãƒ’ãƒƒãƒˆ</button>
        <button id="standButton" disabled>ã‚¹ã‚¿ãƒ³ãƒ‰</button>
    </div>

    <div id="postGameButtons" style="display: none;">
        <button id="nextGameButton">æ¬¡ã®å‹è² ã¸</button>
        <button id="endGameButton">çµ‚äº†</button>
    </div>

    <div id="message"></div>
</div>

<script>
    // ----------------------------------------------------
    //  ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã¨å®šæ•°
    // ----------------------------------------------------
    
    // HTMLè¦ç´ ã®å–å¾—
    const dealerCardsEl = document.getElementById('dealerCards');
    const playerCardsEl = document.getElementById('playerCards');
    const dealerScoreEl = document.getElementById('dealerScore');
    const playerScoreEl = document.getElementById('playerScore');
    const messageEl = document.getElementById('message');
    const dealButton = document.getElementById('dealButton');
    const hitButton = document.getElementById('hitButton');
    const standButton = document.getElementById('standButton');
    const difficultySelect = document.getElementById('difficulty');
    const betAmountInput = document.getElementById('betAmount');
    const chipsAmountEl = document.getElementById('chipsAmount');
    const winStreakEl = document.getElementById('winStreak');
    const preGameControls = document.getElementById('preGameControls');
    const postGameButtons = document.getElementById('postGameButtons');
    const nextGameButton = document.getElementById('nextGameButton');
    const endGameButton = document.getElementById('endGameButton');
    const ruleModal = document.getElementById('ruleModal');
    const closeModalButton = document.getElementById('closeModal');

    // ã‚²ãƒ¼ãƒ å¤‰æ•°
    let deck = [];
    let dealerHand = [];
    let playerHand = [];
    let isGameOver = true;
    let chips = 1000; // åˆæœŸãƒãƒƒãƒ—
    let currentBet = 0;
    let winStreak = 0; // é€£ç¶šå‹åˆ©æ•°

    // ã‚«ãƒ¼ãƒ‰ã®å®šç¾©
    const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
    const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    
    // é›£æ˜“åº¦ã¨åˆæœŸãƒãƒƒãƒ—ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    // valueã¯ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ã‚¹ãƒˆãƒƒãƒ—å€¤ã«å¯¾å¿œ
    const difficultySettings = {
        '14': { chip: 2000, name: 'ã‚¤ãƒ¼ã‚¸ãƒ¼' }, // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒã™ãæ­¢ã¾ã‚‹
        '17': { chip: 1000, name: 'ãƒãƒ¼ãƒãƒ«' }, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§17ã‚¹ãƒˆãƒƒãƒ—
        '18': { chip: 500, name: 'ãƒãƒ¼ãƒ‰' }  // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒç²˜ã‚‹
    };
    // é›£æ˜“åº¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å†è¨­å®š (åˆæœŸãƒãƒƒãƒ—åæ˜ ã®ãŸã‚)
    difficultySelect.innerHTML = `
        <option value="14">ã‚¤ãƒ¼ã‚¸ãƒ¼ (åˆæœŸãƒãƒƒãƒ—: 2000)</option>
        <option value="17" selected>ãƒãƒ¼ãƒãƒ« (åˆæœŸãƒãƒƒãƒ—: 1000)</option>
        <option value="18">ãƒãƒ¼ãƒ‰ (åˆæœŸãƒãƒƒãƒ—: 500)</option>
    `;

    /**
     * ãƒãƒƒãƒ—è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
     */
    function updateChipsDisplay() {
        chipsAmountEl.textContent = chips;
        winStreakEl.textContent = winStreak;
        // ãƒ™ãƒƒãƒˆé¡ã®æœ€å¤§å€¤ã‚’ç¾åœ¨ã®ãƒãƒƒãƒ—ã«åˆã‚ã›ã‚‹
        betAmountInput.max = chips;
        // ãƒãƒƒãƒ—ãŒãƒ™ãƒƒãƒˆé¡ã‚ˆã‚Šå°‘ãªããªã£ãŸã‚‰ã€ãƒ™ãƒƒãƒˆé¡ã‚’ãƒãƒƒãƒ—é¡ã«èª¿æ•´
        if (parseInt(betAmountInput.value) > chips) {
            betAmountInput.value = chips;
        }
        if (chips < 10 && !isGameOver) { // ãƒãƒƒãƒ—ãŒ10æœªæº€ã§ã‚²ãƒ¼ãƒ ä¸­ã§ãªã„å ´åˆ
            // ãƒãƒƒãƒ—ãŒãªããªã£ãŸå ´åˆã®ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†ã‚’å‘¼ã¶
            endGame(null, null, true); // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¼·åˆ¶è¡¨ç¤º
        }
    }

    /**
     * ãƒ‡ãƒƒã‚­ã‚’åˆæœŸåŒ–ã—ã€ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹
     */
    function createAndShuffleDeck() {
        deck = [];
        for (let suit of suits) {
            for (let value of values) {
                deck.push({ suit, value });
            }
        }
        // Fisher-Yatesã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
    }

    /**
     * ãƒ‡ãƒƒã‚­ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’1æšå¼•ã
     */
    function drawCard() {
        return deck.pop();
    }

    /**
     * ã‚«ãƒ¼ãƒ‰ã®ç‚¹æ•°ã‚’è¨ˆç®—ã™ã‚‹
     * @param {Array} hand - æ‰‹æœ­ã®é…åˆ—
     * @returns {number} - åˆè¨ˆç‚¹
     */
    function calculateScore(hand) {
        let score = 0;
        let hasAce = 0;

        for (let card of hand) {
            if (['K', 'Q', 'J'].includes(card.value)) {
                score += 10;
            } else if (card.value === 'A') {
                score += 11;
                hasAce++;
            } else {
                score += parseInt(card.value);
            }
        }

        // A (ã‚¨ãƒ¼ã‚¹) ã®èª¿æ•´ (11ç‚¹ã‹ã‚‰1ç‚¹ã«å¤‰æ›´)
        while (score > 21 && hasAce > 0) {
            score -= 10;
            hasAce--;
        }
        return score;
    }

    /**
     * ã‚«ãƒ¼ãƒ‰ã‚’HTMLã§è¡¨ç¤ºã™ã‚‹
     * @param {Object} card - ã‚«ãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     * @param {boolean} isHidden - è£å‘ãã«ã™ã‚‹ã‹
     * @returns {string} - ã‚«ãƒ¼ãƒ‰ã®HTMLæ–‡å­—åˆ—
     */
    function getCardHtml(card, isHidden = false) {
        if (isHidden) {
            return `<div class="card hidden">DEALER<br>CARD</div>`;
        }
        const color = (card.suit === 'â™¥' || card.suit === 'â™¦') ? 'red' : 'black';
        return `
            <div class="card" style="color: ${color};">
                <div class="card-value">${card.value}</div>
                <div class="card-suit" style="font-size: 1.5em;">${card.suit}</div>
                <div class="card-value">${card.value}</div>
            </div>
        `;
    }

    /**
     * æ‰‹æœ­ã‚’ç”»é¢ã«æç”»ã™ã‚‹
     */
    function renderHands(hideDealerFirst = true) {
        dealerCardsEl.innerHTML = dealerHand.map((card, index) => 
            getCardHtml(card, hideDealerFirst && index === 0)
        ).join('');
        playerCardsEl.innerHTML = playerHand.map(card => getCardHtml(card)).join('');

        const dealerScore = calculateScore(dealerHand);
        const playerScore = calculateScore(playerHand);
        
        // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ç‚¹æ•°ã¯ã€è£å‘ãã®ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤ºã—ãªã„
        dealerScoreEl.textContent = hideDealerFirst ? '?' : dealerScore;
        playerScoreEl.textContent = playerScore;
    }

    /**
     * ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã®å‡¦ç† (ãƒ™ãƒƒãƒˆå‡¦ç†ã‚’è¿½åŠ )
     */
    function startGame() {
        if (isGameOver && chips <= 0) { // ãƒãƒƒãƒ—ãŒ0ã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
            const selectedDifficulty = difficultySelect.value;
            chips = difficultySettings[selectedDifficulty].chip;
            winStreak = 0;
            dealButton.textContent = "å‹è² é–‹å§‹";
            messageEl.textContent = `ãƒãƒƒãƒ—ãŒè£œå……ã•ã‚Œã¾ã—ãŸï¼ åˆæœŸãƒãƒƒãƒ—: ${chips}`;
            updateChipsDisplay();
            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™ãŸã‚ä¸€åº¦ã‚¯ãƒªã‚¢
            endGame(null, null, false);
            return; // æœ€åˆã®startGameå‘¼ã³å‡ºã—ã¯ãƒãƒƒãƒ—è£œå……ã§çµ‚äº†
        }

        currentBet = parseInt(betAmountInput.value);
        
        if (currentBet < 10 || currentBet > chips || isNaN(currentBet)) {
            messageEl.textContent = `æœ‰åŠ¹ãªãƒ™ãƒƒãƒˆé¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (10ã€œ${chips})ã€‚`;
            return;
        }
        
        chips -= currentBet; // ãƒãƒƒãƒ—ã‚’å¼•ã
        updateChipsDisplay();

        messageEl.textContent = `ãƒ™ãƒƒãƒˆé¡ ${currentBet}ã€‚å‹è² é–‹å§‹ï¼`;

        isGameOver = false;
        createAndShuffleDeck();
        dealerHand = [];
        playerHand = [];
        
        // UIã®åˆ‡ã‚Šæ›¿ãˆ
        dealButton.style.display = 'none';
        postGameButtons.style.display = 'none';
        hitButton.disabled = false;
        standButton.disabled = false;
        preGameControls.style.display = 'none';
        document.getElementById('buttons').style.display = 'block';


        playerHand.push(drawCard());
        dealerHand.push(drawCard()); // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®1æšç›® (è£å‘ã)
        playerHand.push(drawCard());
        dealerHand.push(drawCard()); // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®2æšç›® (è¡¨å‘ã)

        renderHands(true);
        checkBlackjack();
    }
    
    /**
     * ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯ã®ãƒã‚§ãƒƒã‚¯
     */
    function checkBlackjack() {
        const playerScore = calculateScore(playerHand);
        if (playerScore === 21 && playerHand.length === 2) { // 2æšã§ã®21ã¯ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯
             // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒBJã®å ´åˆã€ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®éš ã—ã‚«ãƒ¼ãƒ‰ã‚’é–‹ã‘ã¦ãƒã‚§ãƒƒã‚¯
             renderHands(false);
             const dealerScore = calculateScore(dealerHand);
             if (dealerScore === 21 && dealerHand.length === 2) {
                 endGame(playerScore, dealerScore); // ä¸¡è€…BJã§ãƒ—ãƒƒã‚·ãƒ¥
             } else {
                 endGame(playerScore, dealerScore); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼BJå‹ã¡
             }
        } else if (playerScore === 21) {
            playerStand(); // 21ã«ãªã£ãŸã‚‰å¼·åˆ¶ã‚¹ã‚¿ãƒ³ãƒ‰ (BJã§ã¯ãªã„)
        }
    }

    /**
     * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒ’ãƒƒãƒˆã—ãŸæ™‚ã®å‡¦ç†
     */
    function playerHit() {
        if (isGameOver) return;

        playerHand.push(drawCard());
        renderHands(true);

        const playerScore = calculateScore(playerHand);

        if (playerScore > 21) {
            endGame(playerScore, calculateScore(dealerHand)); // ãƒã‚¹ãƒˆ
        } else if (playerScore === 21) {
            playerStand(); // 21ã«ãªã£ãŸã‚‰å¼·åˆ¶ã‚¹ã‚¿ãƒ³ãƒ‰
        }
    }

    /**
     * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚¹ã‚¿ãƒ³ãƒ‰ã—ãŸæ™‚ã®å‡¦ç† (ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ã‚¿ãƒ¼ãƒ³)
     * é€£ç¶šå‹åˆ©æ•°ã«å¿œã˜ã¦ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ã‚¹ãƒˆãƒƒãƒ—å€¤ã‚’èª¿æ•´
     */
    function playerStand() {
        if (isGameOver) return;
        
        hitButton.disabled = true;
        standButton.disabled = true;

        renderHands(false); // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®1æšç›®ã‚’å…¬é–‹
        
        let dealerScore = calculateScore(dealerHand);
        const playerScore = calculateScore(playerHand);
        
        // â˜…ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ã‚¹ãƒˆãƒƒãƒ—å€¤ã‚’è¨­å®šâ˜…
        let baseStopValue = parseInt(difficultySelect.value);

        // é€£ç¶šå‹åˆ©æ•°ã«å¿œã˜ã¦ã‚¹ãƒˆãƒƒãƒ—å€¤ã‚’å³ã—ãã™ã‚‹
        // 5é€£å‹ã”ã¨ã«ã‚¹ãƒˆãƒƒãƒ—å€¤ãŒ+1ã•ã‚Œã‚‹ (æœ€å¤§18ã¾ã§)
        let stopValue = baseStopValue + Math.floor(winStreak / 5);
        if (stopValue > 18) stopValue = 18; // 18ã‚’è¶…ãˆã‚‹ã“ã¨ã¯ãªã„


        const dealerTurn = () => {
            if (isGameOver) return;
            
            // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã¯è¨­å®šã•ã‚ŒãŸã‚¹ãƒˆãƒƒãƒ—å€¤ä»¥ä¸Šã«ãªã‚‹ã¾ã§ãƒ’ãƒƒãƒˆã™ã‚‹
            if (dealerScore < stopValue) {
                setTimeout(() => {
                    dealerHand.push(drawCard());
                    dealerScore = calculateScore(dealerHand);
                    renderHands(false);
                    dealerTurn(); // å†åº¦ãƒã‚§ãƒƒã‚¯
                }, 1000); // 1ç§’å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
            } else {
                endGame(playerScore, dealerScore);
            }
        };

        dealerTurn();
    }

    /**
     * ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã®å‡¦ç†ã¨å‹æ•—åˆ¤å®š (ãƒãƒƒãƒ—è¨ˆç®—ã‚’è¿½åŠ )
     * @param {number} playerScore - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æœ€çµ‚ç‚¹æ•°
     * @param {number} dealerScore - ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®æœ€çµ‚ç‚¹æ•°
     * @param {boolean} forcedGameOver - ãƒãƒƒãƒ—åˆ‡ã‚Œãªã©ã§å¼·åˆ¶ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã®å ´åˆ
     */
    function endGame(playerScore, dealerScore, forcedGameOver = false) {
        isGameOver = true;
        renderHands(false); // å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ã‚’å…¬é–‹

        let resultMessage = '';
        let win = false;
        const bet = currentBet;

        if (forcedGameOver) {
            resultMessage = "ãƒãƒƒãƒ—ãŒãªããªã‚Šã¾ã—ãŸ... ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã€‚";
        } else if (playerScore > 21) {
            resultMessage = `ãƒã‚¹ãƒˆï¼ (${playerScore})ã€‚ã‚ãªãŸã®è² ã‘ã§ã™ã€‚ãƒãƒƒãƒ—ã‚’å¤±ã„ã¾ã—ãŸ (-${bet})`;
        } else if (dealerScore > 21) {
            chips += bet * 2; // å…ƒé‡‘ + å‹åˆ©é‡‘
            win = true;
            resultMessage = `ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãƒã‚¹ãƒˆï¼ (${dealerScore})ã€‚ã‚ãªãŸã®å‹ã¡ã§ã™ï¼ ãƒãƒƒãƒ—+${bet}`;
        } else if (playerScore === dealerScore) {
            chips += bet; // è³­ã‘é‡‘ãŒæˆ»ã‚‹ (ãƒ—ãƒƒã‚·ãƒ¥)
            resultMessage = `ãƒ—ãƒƒã‚·ãƒ¥ (å¼•ãåˆ†ã‘) ã§ã™ã€‚ãƒ™ãƒƒãƒˆé¡ãŒæˆ»ã‚Šã¾ã™ã€‚`;
        } else if (playerScore === 21 && playerHand.length === 2) { // 2æšã§ã®21ã¯ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯
            chips += bet * 2.5; // å…ƒé‡‘ + å‹åˆ©é‡‘(1.5å€)
            win = true;
            resultMessage = `ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯ï¼ (${playerScore})ã€‚ãƒãƒƒãƒ—+${bet * 1.5}`;
        } else if (playerScore > dealerScore) {
            chips += bet * 2; // å…ƒé‡‘ + å‹åˆ©é‡‘
            win = true;
            resultMessage = `ã‚ãªãŸã®å‹ã¡ã§ã™ï¼ (${playerScore} å¯¾ ${dealerScore})ã€‚ãƒãƒƒãƒ—+${bet}`;
        } else {
            resultMessage = `ã‚ãªãŸã®è² ã‘ã§ã™ã€‚ (${playerScore} å¯¾ ${dealerScore})ã€‚ãƒãƒƒãƒ—ã‚’å¤±ã„ã¾ã—ãŸ (-${bet})`;
        }

        // é€£ç¶šå‹åˆ©ã®æ›´æ–°
        if (win) {
            winStreak++;
        } else if (!forcedGameOver && resultMessage.includes('ãƒ—ãƒƒã‚·ãƒ¥') === false) { // è² ã‘ãŸå ´åˆã®ã¿ãƒªã‚»ãƒƒãƒˆ
            winStreak = 0;
        }

        messageEl.textContent = resultMessage;
        updateChipsDisplay();
        
        // UIã®åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('buttons').style.display = 'none';
        preGameControls.style.display = 'flex';
        
        if (chips <= 0) {
            // ãƒãƒƒãƒ—ãŒ0ã«ãªã£ãŸå ´åˆã®ç‰¹åˆ¥ãªå‡¦ç†
            messageEl.textContent = "ãƒãƒƒãƒ—ãŒãªããªã‚Šã¾ã—ãŸ... ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã€‚é›£æ˜“åº¦ã‚’é¸æŠã—ã¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚";
            postGameButtons.style.display = 'none'; // æ¬¡ã®å‹è² ã€çµ‚äº†ãƒœã‚¿ãƒ³ã¯è¡¨ç¤ºã—ãªã„
            dealButton.style.display = 'block'; // ã€Œå‹è² é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆå†ã‚¹ã‚¿ãƒ¼ãƒˆç”¨ï¼‰
            dealButton.textContent = "ã‚²ãƒ¼ãƒ å†é–‹";
            dealButton.disabled = false; // å†é–‹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            // ãƒ™ãƒƒãƒˆé¡å…¥åŠ›ã‚‚ç„¡åŠ¹åŒ– (ãƒãƒƒãƒ—0ãªã®ã§è³­ã‘ã‚‰ã‚Œãªã„)
            betAmountInput.disabled = true;
        } else {
            postGameButtons.style.display = 'block';
            dealButton.style.display = 'none'; // é€šå¸¸ã®ã€Œå‹è² é–‹å§‹ã€ã¯éš ã™
            betAmountInput.disabled = false;
            // æ¬¡ã®ãƒ™ãƒƒãƒˆé¡ã‚’èª¿æ•´ (ç¾åœ¨ã®ãƒãƒƒãƒ—ã‚ˆã‚Šå¤šããªã‚‰ãªã„ã‚ˆã†ã«)
            betAmountInput.value = parseInt(betAmountInput.value) > chips ? chips : (parseInt(betAmountInput.value) < 10 ? 10 : parseInt(betAmountInput.value));
        }
    }

    // ----------------------------------------------------
    //  ã‚¤ãƒ™ãƒ³ãƒˆã¨åˆæœŸåŒ–
    // ----------------------------------------------------
    
    // é›£æ˜“åº¦å¤‰æ›´æ™‚ã€åˆæœŸãƒãƒƒãƒ—ã‚’æ›´æ–°
    difficultySelect.addEventListener('change', () => {
        const selectedDifficulty = difficultySelect.value;
        chips = difficultySettings[selectedDifficulty].chip;
        winStreak = 0; // é›£æ˜“åº¦å¤‰æ›´ã§é€£å‹ãƒªã‚»ãƒƒãƒˆ
        isGameOver = true; // é›£æ˜“åº¦å¤‰æ›´ã§å¼·åˆ¶çš„ã«ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼çŠ¶æ…‹ã«
        dealButton.textContent = "å‹è² é–‹å§‹"; // ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        betAmountInput.disabled = false; // ãƒ™ãƒƒãƒˆå…¥åŠ›ã‚‚æœ‰åŠ¹åŒ–
        messageEl.textContent = 'ãƒ™ãƒƒãƒˆé¡ã¨é›£æ˜“åº¦ã‚’è¨­å®šã—ã€å‹è² é–‹å§‹ï¼';
        updateChipsDisplay();
    });

    // ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
    dealButton.addEventListener('click', startGame);
    hitButton.addEventListener('click', playerHit);
    standButton.addEventListener('click', playerStand);
    
    // çµ‚äº†å¾Œãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    nextGameButton.addEventListener('click', () => {
        // æ¬¡ã®ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã«ã€ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã®UIã«æˆ»ã™
        document.getElementById('buttons').style.display = 'block';
        postGameButtons.style.display = 'none';
        dealButton.style.display = 'block'; // ã€Œå‹è² é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        dealButton.disabled = false; // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        
        startGame(); // æ¬¡ã®ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
    });

    endGameButton.addEventListener('click', () => {
        messageEl.textContent = `ã‚²ãƒ¼ãƒ çµ‚äº†ã€‚æœ€çµ‚ãƒãƒƒãƒ—: ${chips}ã€‚ã¾ãŸã®ãŠè¶Šã—ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ï¼`;
        // å…¨ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã€UIã‚’ã‚²ãƒ¼ãƒ çµ‚äº†çŠ¶æ…‹ã«ã™ã‚‹
        dealButton.disabled = true;
        nextGameButton.disabled = true;
        endGameButton.disabled = true;
        hitButton.disabled = true;
        standButton.disabled = true;
        preGameControls.style.display = 'none'; // ãƒ™ãƒƒãƒˆ/é›£æ˜“åº¦é¸æŠã‚‚éš ã™
        document.getElementById('buttons').style.display = 'none'; // ãƒ’ãƒƒãƒˆ/ã‚¹ã‚¿ãƒ³ãƒ‰ãƒœã‚¿ãƒ³ã‚‚éš ã™
        
        isGameOver = true; // å®Œå…¨ã«ã‚²ãƒ¼ãƒ çµ‚äº†çŠ¶æ…‹
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
    function hideModal() {
        ruleModal.style.display = 'none';
        messageEl.textContent = 'ãƒ™ãƒƒãƒˆé¡ã¨é›£æ˜“åº¦ã‚’è¨­å®šã—ã€å‹è² é–‹å§‹ï¼';
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ãŸå¾Œã®åˆæœŸåŒ–å‡¦ç†
        const selectedDifficulty = difficultySelect.value;
        chips = difficultySettings[selectedDifficulty].chip; // åˆæœŸãƒãƒƒãƒ—ã‚’è¨­å®š
        updateChipsDisplay();
    }
    closeModalButton.addEventListener('click', hideModal);

    // åˆæœŸåŒ–
    updateChipsDisplay();
    ruleModal.style.display = 'flex'; // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ«ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    messageEl.textContent = 'ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªä¸­ã§ã™...';

</script>
</body>
</html>
