<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ブラックジャック - カジノモード</title>
    <style>
        /* ======================== */
        /* ゲーム画面のCSS - カジノ風背景 (キラキラ強化) */
        /* ======================== */
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background-color: #0d230d; /* さらに深いダークグリーン */
            /* キラキラしたカジノの照明をイメージした豪華な背景 */
            background-image: 
                radial-gradient(circle at center, rgba(255, 255, 255, 0.1) 0%, rgba(0, 0, 0, 0) 60%),
                radial-gradient(ellipse at bottom left, #ccac00 0%, transparent 40%),
                radial-gradient(ellipse at top right, #ff9800 0%, transparent 40%),
                repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.05) 0px, rgba(255, 255, 255, 0.05) 1px, transparent 1px, transparent 5px);
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: rgba(0, 0, 0, 0.75);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.3); /* ゴールドの輝き */
            border: 5px solid #ccac00;
        }
        
        /* インフォメーションエリア (チップ、連勝数) */
        #infoBar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #0b4920;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: bold;
        }
        .info-item {
            display: flex;
            align-items: center;
        }
        .chip-icon { color: gold; margin-right: 5px; font-size: 1.2em; }
        .win-streak-icon { color: #ff4500; margin-right: 5px; font-size: 1.2em; }

        /* ベット/難易度選択エリア */
        #preGameControls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
        }
        select, input[type="number"] {
            padding: 8px;
            border-radius: 5px;
            font-size: 1em;
            background-color: #fff;
            color: #333;
            border: 1px solid #ccc;
        }
        
        /* ゲーム要素のスタイル（前回同様） */
        .hand { margin-bottom: 20px; border: 2px dashed #66bb6a; padding: 15px; border-radius: 8px; }
        .cards { display: flex; justify-content: center; margin: 10px 0; min-height: 100px; flex-wrap: wrap; }
        .card { 
            /* カードの色調整 */
            background-color: #fff; color: #000; border: 1px solid #000; border-radius: 5px;
            width: 70px; height: 90px; display: flex; flex-direction: column; justify-content: space-between;
            align-items: center; margin: 0 5px; padding: 5px; font-size: 1.2em;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3); font-weight: bold;
        }
        .card.hidden { background-color: #8b0000; color: #fff; font-size: 1em; display: flex; justify-content: center; align-items: center; font-style: italic; }
        
        /* ボタンのスタイル */
        button { padding: 10px 20px; font-size: 1em; margin: 5px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-weight: bold; }
        #dealButton { background-color: #2196f3; color: #fff; }
        #dealButton:hover { background-color: #1e88e5; }
        #hitButton { background-color: #ff9800; color: #fff; }
        #hitButton:hover { background-color: #e68900; }
        #standButton { background-color: #4caf50; color: #fff; }
        #standButton:hover { background-color: #43a047; }
        
        /* 終了後ボタン */
        #postGameButtons { margin-top: 20px; }
        #nextGameButton { background-color: #ccac00; color: #333; }
        #endGameButton { background-color: #8b0000; color: #fff; }
        #nextGameButton:hover { background-color: #b29300; }
        #endGameButton:hover { background-color: #6a0000; }

        #message { font-size: 1.5em; margin-top: 20px; font-weight: bold; }
        
        /* モーダルのスタイル (前回同様) */
        .modal-overlay { /* ... 省略 ... */ }
        .modal-content { /* ... 省略 ... */ }
        .close-button { /* ... 省略 ... */ }
        .rule-title { /* ... 省略 ... */ }
        .rule-list { /* ... 省略 ... */ }

    </style>
</head>
<body>

<div id="ruleModal" class="modal-overlay">
    <div class="modal-content">
        <button id="closeModal" class="close-button">&times;</button>
        <h2 class="rule-title">♦ ブラックジャックのルール ♦</h2>
        
        <ul class="rule-list">
            <li>目標は、手札の合計を **21に近づける**ことです。21を超えると**バスト（負け）**となります。</li>
            <li>**カードの数え方:** A=1点または11点, J/Q/K=10点, 2〜10=そのままの数字。</li>
            <li>**【チップとベット】** ゲーム開始時に**賭け金 (ベット)** を決めます。
                <ul>
                    <li>**勝利**: 賭け金の**2倍**が戻ります。</li>
                    <li>**ブラックジャック (21点)**: 賭け金の**2.5倍**が戻ります。</li>
                    <li>**プッシュ (引き分け)**: 賭け金がそのまま戻ります。</li>
                </ul>
            </li>
            <li>**HIT (ヒット)**: カードをもう1枚引きます。</li>
            <li>**STAND (スタンド)**: 現在の手札で勝負し、ディーラーのターンに移ります。</li>
        </ul>
        
        <p>※ このゲームは純粋な練習用であり、金銭は一切関わりません。</p>
        <div class="modal-actions">
             <p style="color:#8b0000; font-weight: bold;">準備ができたら、右上の [✕] ボタンで閉じましょう。</p>
        </div>
    </div>
</div>

<div class="container">
    <h1>BLACKJACK</h1>
    
    <div id="infoBar">
        <div class="info-item">
            <span class="chip-icon">💰</span> チップ: <span id="chipsAmount">1000</span>
        </div>
        <div class="info-item">
            <span class="win-streak-icon">🔥</span> 連続勝利: <span id="winStreak">0</span>
        </div>
    </div>

    <div id="preGameControls">
        <div>
            <label for="difficulty">難易度:</label>
            <select id="difficulty">
                <option value="17">イージー</option>
                <option value="17" selected>ノーマル</option>
                <option value="18">ハード</option>
            </select>
        </div>
        <div>
            <label for="betAmount">ベット額:</label>
            <input type="number" id="betAmount" value="50" min="10" step="10">
        </div>
    </div>
    
    <div id="dealerHand" class="hand">
        <h2>ディーラーの手札: <span id="dealerScore">0</span></h2>
        <div id="dealerCards" class="cards"></div>
    </div>

    <div id="playerHand" class="hand">
        <h2>あなたの手札: <span id="playerScore">0</span></h2>
        <div id="playerCards" class="cards"></div>
    </div>

    <div id="buttons">
        <button id="dealButton">勝負開始</button>
        <button id="hitButton" disabled>ヒット</button>
        <button id="standButton" disabled>スタンド</button>
    </div>

    <div id="postGameButtons" style="display: none;">
        <button id="nextGameButton">次の勝負へ</button>
        <button id="endGameButton">終了</button>
    </div>

    <div id="message"></div>
</div>

<script>
    // ----------------------------------------------------
    //  ゲームの状態と定数
    // ----------------------------------------------------
    
    // HTML要素の取得
    const dealerCardsEl = document.getElementById('dealerCards');
    const playerCardsEl = document.getElementById('playerCards');
    const dealerScoreEl = document.getElementById('dealerScore');
    const playerScoreEl = document.getElementById('playerScore');
    const messageEl = document.getElementById('message');
    const dealButton = document.getElementById('dealButton');
    const hitButton = document.getElementById('hitButton');
    const standButton = document.getElementById('standButton');
    const difficultySelect = document.getElementById('difficulty');
    const betAmountInput = document.getElementById('betAmount');
    const chipsAmountEl = document.getElementById('chipsAmount');
    const winStreakEl = document.getElementById('winStreak');
    const preGameControls = document.getElementById('preGameControls');
    const postGameButtons = document.getElementById('postGameButtons');
    const nextGameButton = document.getElementById('nextGameButton');
    const endGameButton = document.getElementById('endGameButton');
    const ruleModal = document.getElementById('ruleModal');
    const closeModalButton = document.getElementById('closeModal');

    // ゲーム変数
    let deck = [];
    let dealerHand = [];
    let playerHand = [];
    let isGameOver = true;
    let chips = 1000; // 初期チップ
    let currentBet = 0;
    let winStreak = 0; // 連続勝利数

    // カードの定義
    const suits = ['♠', '♥', '♦', '♣'];
    const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    
    // 難易度と初期チップのマッピング
    const difficultySettings = {
        '17': { chip: 1000, name: 'ノーマル' }, // デフォルトで17ストップ
        '14': { chip: 2000, name: 'イージー' }, // ディーラーがすぐ止まる
        '18': { chip: 500, name: 'ハード' }  // ディーラーが粘る
    };
    // 難易度プルダウンの再設定 (初期チップ反映のため)
    difficultySelect.innerHTML = `
        <option value="14">イージー (チップ: 2000)</option>
        <option value="17" selected>ノーマル (チップ: 1000)</option>
        <option value="18">ハード (チップ: 500)</option>
    `;

    /**
     * チップ表示を更新する
     */
    function updateChipsDisplay() {
        chipsAmountEl.textContent = chips;
        winStreakEl.textContent = winStreak;
        betAmountInput.max = chips;
    }

    // ... (createAndShuffleDeck, drawCard, calculateScore, getCardHtml, renderHands, checkBlackjack, playerHit は前回のものを利用) ...

    /*
     * 変更のあった主要関数のみ記載します
     */

    /**
     * ゲーム開始時の処理 (ベット処理を追加)
     */
    function startGame() {
        if (isGameOver) {
            currentBet = parseInt(betAmountInput.value);
            
            if (currentBet < 10 || currentBet > chips || isNaN(currentBet)) {
                messageEl.textContent = `有効なベット額を入力してください (10〜${chips})。`;
                return;
            }

            chips -= currentBet; // チップを引く
            updateChipsDisplay();

            messageEl.textContent = `ベット額 ${currentBet}。勝負開始！`;
        } else {
            messageEl.textContent = '次の勝負へ...';
        }

        isGameOver = false;
        createAndShuffleDeck();
        dealerHand = [];
        playerHand = [];
        
        // UIの切り替え
        dealButton.style.display = 'none';
        postGameButtons.style.display = 'none';
        hitButton.disabled = false;
        standButton.disabled = false;
        preGameControls.style.display = 'none';
        document.getElementById('buttons').style.display = 'block';


        playerHand.push(drawCard());
        dealerHand.push(drawCard());
        playerHand.push(drawCard());
        dealerHand.push(drawCard());

        renderHands(true);
        checkBlackjack();
    }
    
    /**
     * プレイヤーがスタンドした時の処理 (ディーラーのターン)
     * 連続勝利数に応じてディーラーのストップ値を調整
     */
    function playerStand() {
        if (isGameOver) return;
        
        hitButton.disabled = true;
        standButton.disabled = true;

        renderHands(false);
        
        let dealerScore = calculateScore(dealerHand);
        const playerScore = calculateScore(playerHand);
        
        // ★ディーラーのストップ値を設定★
        let baseStopValue = parseInt(difficultySelect.value);

        // 連続勝利数に応じてストップ値を厳しくする
        // 5連勝ごとにストップ値が+1される (最大18まで)
        let stopValue = baseStopValue + Math.floor(winStreak / 5);
        if (stopValue > 18) stopValue = 18;


        const dealerTurn = () => {
            if (isGameOver) return;
            
            if (dealerScore < stopValue) {
                setTimeout(() => {
                    dealerHand.push(drawCard());
                    dealerScore = calculateScore(dealerHand);
                    renderHands(false);
                    dealerTurn();
                }, 1000); 
            } else {
                endGame(playerScore, dealerScore);
            }
        };

        dealerTurn();
    }

    /**
     * ゲーム終了時の処理と勝敗判定 (チップ計算を追加)
     */
    function endGame(playerScore, dealerScore) {
        isGameOver = true;
        renderHands(false);

        let resultMessage = '';
        let chipChange = 0;
        let win = false;
        const bet = currentBet;

        if (playerScore > 21) {
            resultMessage = `バスト！ あなたの負けです。チップを失いました (-${bet})`;
        } else if (dealerScore > 21) {
            chipChange = bet; // 賭け金の2倍 (元金+勝利金)
            chips += bet * 2;
            win = true;
            resultMessage = `ディーラーバスト！ あなたの勝ちです！ チップ+${bet}`;
        } else if (playerScore === dealerScore) {
            chips += bet; // 賭け金が戻る (プッシュ)
            resultMessage = `プッシュ (引き分け) です。ベット額が戻ります。`;
        } else if (playerScore === 21 && playerHand.length === 2) {
            chipChange = bet * 1.5; // ブラックジャックは2.5倍
            chips += bet * 2.5;
            win = true;
            resultMessage = `ブラックジャック！ チップ+${chipChange} (2.5倍)`;
        } else if (playerScore > dealerScore) {
            chipChange = bet;
            chips += bet * 2;
            win = true;
            resultMessage = `あなたの勝ちです！ チップ+${bet}`;
        } else {
            resultMessage = `あなたの負けです。 チップを失いました (-${bet})`;
        }

        // 連続勝利の更新
        if (win) {
            winStreak++;
        } else if (resultMessage.includes('プッシュ') === false) {
            winStreak = 0;
        }

        messageEl.textContent = resultMessage;
        updateChipsDisplay();
        
        // UIの切り替え
        document.getElementById('buttons').style.display = 'none';
        postGameButtons.style.display = 'block';
        preGameControls.style.display = 'flex';
        betAmountInput.value = chips > bet ? bet : chips; // 次のベット額を調整

        if (chips <= 0) {
            messageEl.textContent = "チップがなくなりました... ゲームオーバー。";
            postGameButtons.style.display = 'none';
            dealButton.textContent = "最初からやり直す";
            dealButton.style.display = 'block';
        }
    }

    // ----------------------------------------------------
    //  イベントと初期化
    // ----------------------------------------------------
    
    // 難易度変更時、初期チップを更新
    difficultySelect.addEventListener('change', () => {
        const value = difficultySelect.value;
        if (value === '14') chips = 2000; // イージー
        else if (value === '18') chips = 500; // ハード
        else chips = 1000; // ノーマル
        
        winStreak = 0; // 難易度変更で連勝リセット
        updateChipsDisplay();
    });

    // ゲームコントロールイベント
    dealButton.addEventListener('click', () => {
        if (chips <= 0 && isGameOver) {
            // ゲームオーバーからのリスタート
            const value = difficultySelect.value;
            if (value === '14') chips = 2000;
            else if (value === '18') chips = 500;
            else chips = 1000;
            winStreak = 0;
            dealButton.textContent = "勝負開始";
        }
        startGame();
    });
    
    hitButton.addEventListener('click', playerHit);
    standButton.addEventListener('click', playerStand);
    
    // 終了後ボタンのイベント
    nextGameButton.addEventListener('click', startGame);
    endGameButton.addEventListener('click', () => {
        messageEl.textContent = `ゲーム終了。最終チップ: ${chips}。またのお越しをお待ちしております！`;
        // 全ボタンを無効化
        dealButton.disabled = true;
        nextGameButton.disabled = true;
        endGameButton.disabled = true;
    });

    // モーダルイベント
    function hideModal() {
        ruleModal.style.display = 'none';
        messageEl.textContent = 'ベット額と難易度を設定し、勝負開始！';
    }
    closeModalButton.addEventListener('click', hideModal);

    // 初期化
    updateChipsDisplay();
    ruleModal.style.display = 'flex';
    messageEl.textContent = 'ルールを確認中です...';

    // ----------------------------------------------------
    // ⚠️ 前回のコードから引き継ぐ必要のある関数 (コードの簡略化のため再掲)
    // ----------------------------------------------------
    
    // (createAndShuffleDeck, drawCard, calculateScore, getCardHtml, checkBlackjack, playerHit, renderHands の定義をここに含めてください)
    
    function createAndShuffleDeck() {
        deck = [];
        for (let suit of suits) {
            for (let value of values) {
                deck.push({ suit, value });
            }
        }
        for (let i = deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [deck[i], deck[j]] = [deck[j], deck[i]];
        }
    }

    function drawCard() {
        return deck.pop();
    }

    function calculateScore(hand) {
        let score = 0;
        let hasAce = 0;
        for (let card of hand) {
            if (['K', 'Q', 'J'].includes(card.value)) {
                score += 10;
            } else if (card.value === 'A') {
                score += 11;
                hasAce++;
            } else {
                score += parseInt(card.value);
            }
        }
        while (score > 21 && hasAce > 0) {
            score -= 10;
            hasAce--;
        }
        return score;
    }

    function getCardHtml(card, isHidden = false) {
        if (isHidden) {
            return `<div class="card hidden">DEALER<br>CARD</div>`;
        }
        const color = (card.suit === '♥' || card.suit === '♦') ? 'red' : 'black';
        return `
            <div class="card" style="color: ${color};">
                <div class="card-value">${card.value}</div>
                <div class="card-suit" style="font-size: 1.5em;">${card.suit}</div>
                <div class="card-value">${card.value}</div>
            </div>
        `;
    }

    function renderHands(hideDealerFirst = true) {
        dealerCardsEl.innerHTML = dealerHand.map((card, index) => 
            getCardHtml(card, hideDealerFirst && index === 0)
        ).join('');
        playerCardsEl.innerHTML = playerHand.map(card => getCardHtml(card)).join('');

        const dealerScore = calculateScore(dealerHand);
        const playerScore = calculateScore(playerHand);
        
        dealerScoreEl.textContent = hideDealerFirst ? '?' : dealerScore;
        playerScoreEl.textContent = playerScore;
    }

    function checkBlackjack() {
        const playerScore = calculateScore(playerHand);
        if (playerScore === 21) {
            endGame(playerScore, calculateScore(dealerHand));
        }
    }

    function playerHit() {
        if (isGameOver) return;

        playerHand.push(drawCard());
        renderHands(true);

        const playerScore = calculateScore(playerHand);

        if (playerScore > 21) {
            endGame(playerScore, calculateScore(dealerHand)); 
        } else if (playerScore === 21) {
            playerStand(); 
        }
    }
</script>
</body>
</html>
